# ============================================================
# üìÖ Proyecto: Agenda Inteligente
# ------------------------------------------------------------
# Servicios:
#   - backend (Flask)
#   - db (MySQL 8.0.32)
# ------------------------------------------------------------
# Puerto backend: 5000
# Puerto MySQL:   3310 (externo) ‚Üí 3306 (interno)
# ============================================================

services:
  # ==========================================================
  # üß† Backend Flask
  # ==========================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: agenda-backend
    restart: always
    env_file:
      - .env
    ports:
      - "5000:5000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - agenda_network

  # ==========================================================
  # üóÑÔ∏è Base de datos MySQL
  # ==========================================================
  db:
    image: mysql:8.0.32
    container_name: agenda-db
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: agenda_inteligente
      MYSQL_USER: agenda_user
      MYSQL_PASSWORD: agenda123
    ports:
      - "3310:3306"   # üëà Puerto externo diferente (no interfiere con PIDI ni Contador)
    # Healthcheck proactivo: se autentica contra MySQL en vez de solo abrir el puerto.
    # Esto evita marcar el servicio como healthy antes de que termine la inicializaci√≥n de InnoDB.
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uagenda_user -pagenda123 --silent"]
      interval: 10s      # Revisa el estado cada 10 segundos
      timeout: 5s        # Considera fallo si la respuesta tarda m√°s de 5 segundos
      retries: 12        # Da ~2 minutos para inicializaciones largas en discos lentos
      start_period: 30s  # Respeta el tiempo que MySQL necesita para preparar /var/lib/mysql
    volumes:
      - ./backups:/docker-entrypoint-initdb.d
      - db_data:/var/lib/mysql
    networks:
      - agenda_network

# ============================================================
# üß© Redes y Vol√∫menes
# ============================================================
volumes:
  db_data:

networks:
  agenda_network:
    driver: bridge
