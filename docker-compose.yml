# ============================================================
# üìÖ Proyecto: Agenda Inteligente
# ------------------------------------------------------------
# Servicios:
#   - backend (Flask)
#   - db (MySQL 8.0.32)
# ------------------------------------------------------------
# Puerto backend: 5000
# Puerto MySQL:   3310 (externo) ‚Üí 3306 (interno)
# ============================================================

services:
  # ==========================================================
  # üß† Backend Flask
  # ==========================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: agenda-backend
    restart: always
    env_file:
      - .env
    ports:
      - "5000:5000"
    depends_on:
      db:
        condition: service_started   # Espera a que la DB inicie, sin depender del healthcheck
    volumes:
      - ./backend:/app
    networks:
      - agenda_network

  # ==========================================================
  # üóÑÔ∏è Base de datos MySQL
  # ==========================================================
  db:
    image: mysql:8.0.33
    container_name: agenda-db
    restart: always
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password", "--innodb-force-recovery=1"]
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: agenda_inteligente
      MYSQL_USER: agenda_user
      MYSQL_PASSWORD: agenda123
    ports:
      - "3310:3306"   # Puerto externo ‚Üí interno
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -prootpass --silent"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s
    volumes:
      - ./backups:/docker-entrypoint-initdb.d
      - db_data:/var/lib/mysql
    networks:
      - agenda_network



# ============================================================
# üß© Redes y Vol√∫menes
# ============================================================
volumes:
  db_data:

networks:
  agenda_network:
    driver: bridge

